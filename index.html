<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Until what age do women in different countries survive?</title>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.0.2/jquery.min.js" type="text/javascript"></script>
		<script src="./lib/chosen.jquery.js" type="text/javascript"></script>
		<script src="./lib/prism.js" type="text/javascript" charset="utf-8"></script>
		<script src="./lib/d3.v3.js"></script>
		<script src="./lib/nv.d3.js"></script>

		<link  href="./lib/nv.d3.css" rel="stylesheet" type="text/css">
		<link  href="./lib/chosen.css" rel="stylesheet" type="text/css">
		
	</head>

	<style>
    
    #country-box {
    margin-left: 80px;
    float: none;
    color: gray;
     }


    h1 {
    font: 24px sans-serif;
    color: gray;
    margin-left: 80px;
    margin-bottom: 10px;
    }

    </style>

	<body>
	
	
	<h1>Until what age do women in different countries survive?</h1>
	<svg id="first" style="height:400px; width: 580px"/>

		<div id="country-box">
	    <form>
			<select data-placeholder="Choose or type different countries..." 
			    id = "menu" multiple = "multiple" class = "chosen-select" style="width:350px;" >
			<option></option>
	    </select> 
	    </form>
	  	</div>


	<script>

	//Global variables for passing filtered data

	var data;
	var filteredData;
	var countrySelect = ["Japan", "Sierra Leone"];
	
	//Read data, transform it and filter for countries in countrySelect

	d3.csv("survivors.csv", function(error, csv) {

		csv = csv.map( function (d) { 
		return { 
	      country: d.country,
	      age: +d.age,
	      survivors: +d.survivors
	      }; 
	  	}); 

	  	csv = d3.nest()
		  .key(function(d) { return d.country; })
		  .sortKeys(d3.ascending)
		  .entries(csv)
		  .map(function(d) {
		    var country = d.key
		    var values = d.values.map(function(dd) {      
		      return {x: dd.age, y: Math.round(dd.survivors)}
		    })
		    return {'key':country, 'values':values}
		 });

		filteredData = csv.map(function(d) {return countrySelect.indexOf(d.key) !== -1 ? d : null;})
					.filter(function(n) {return(n)});
		
		data = csv;

		//Populate the menu bar and have it set the contents of countrySelect when it's interacted with

		var menubar = d3.select("body").select("#menu")
		  .attr("class","chosen-select")
		  .selectAll("option").data(data)
		  .enter()
		  .append("option")
		  .text(function(d) {return d.key;});

  	    $(".chosen-select").chosen({width: "470px"})
	       .change(function(evt,params){
	       var multipleValues = $("#menu").val() || [];
	          countrySelect = multipleValues
	          console.log(countrySelect)
	          filteredData = csv.map(function(d) {return countrySelect.indexOf(d.key) !== -1 ? d : null;})
					.filter(function(n) {return(n)});
	          draw();
        })

		draw();
	});

	

	function draw() {

		//a bit hacky but simpler with NVD3 to clear the chart before "re-drawing"

		$("#first").empty();

		nv.addGraph(function() {

		var chart = nv.models.lineChart();

		chart.xAxis
			.axisLabel("Survival Age");

		chart.yAxis
			.axisLabel("Number of Survivors")
			.tickFormat(d3.format("d"));

		chart.forceY([0,100,000]); 

		chart.margin({left: 80});

		chart.interpolate("basis");

		chart.tooltipContent(function(key,x,y) {
		//	return "In " + key + " " + Math.round(y/1000) +"%" + " survived until age " + x;});
			return "<h3>" + key + "</h3>" + "<p>" + Math.round(y/1000) + "%" + " survived until age " + x + "</p>";});

		//the business end: join the filtered data to chart

		d3.select("#first")
			.datum(filteredData)
		.transition().duration(300)
			.call(chart);

		nv.utils.windowResize(
				function() {
					chart.update();
				}
			);

		});

	}

	

	</script>

	</body>
</html>